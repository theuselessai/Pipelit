# Development Plan: Home Agent with Gateway + AIChat Agents

> Integrating Gateway orchestration with AIChat's agent/function system and RQ task queue

---

## Overview

This plan evolves your existing Telegram + AIChat + RQ architecture into a full **Home Automation Agent** with:

1. **Gateway** - Routes requests, plans tasks, manages execution
2. **AIChat Agents** - Browser, System, Research agents with function calling
3. **RQ Workers** - Execute tasks via local `aichat` CLI commands
4. **Macros** - Predefined workflows for common tasks
5. **Dynamic Planner** - LLM-based planning for novel/complex tasks
6. **Persistent Chrome** - Maintains logins for shopping, research, etc.

---

## Target Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              HOME SERVER                                     â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                           â”‚
â”‚  â”‚  Telegram    â”‚                                                           â”‚
â”‚  â”‚    Bot       â”‚                                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                           â”‚
â”‚         â”‚                                                                    â”‚
â”‚         â–¼                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         GATEWAY                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  Router  â”‚ â†’ â”‚ Planner  â”‚ â†’ â”‚  Task      â”‚ â†’ â”‚ Confirmation  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚(classify)â”‚   â”‚(macro or â”‚   â”‚  Enqueuer  â”‚   â”‚   Handler     â”‚   â”‚   â”‚
â”‚  â”‚  â”‚          â”‚   â”‚ dynamic) â”‚   â”‚            â”‚   â”‚   (Redis)     â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                        â”‚
â”‚                                    â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         REDIS                                        â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚   â”‚  high   â”‚   â”‚ default â”‚   â”‚   low   â”‚   â”‚  browser_queue  â”‚    â”‚   â”‚
â”‚  â”‚   â”‚ (cmds)  â”‚   â”‚ (chat)  â”‚   â”‚(cleanup)â”‚   â”‚  (single worker)â”‚    â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚   â”‚  Browser State  â”‚  Pending Confirmations  â”‚  Plan State     â”‚   â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                        â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚         â–¼                          â–¼                          â–¼            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   RQ Worker     â”‚    â”‚   RQ Worker     â”‚    â”‚   RQ Worker     â”‚        â”‚
â”‚  â”‚   (Browser)     â”‚    â”‚   (System)      â”‚    â”‚   (Research)    â”‚        â”‚
â”‚  â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚        â”‚
â”‚  â”‚  aichat --agent â”‚    â”‚  aichat --agent â”‚    â”‚  aichat --agent â”‚        â”‚
â”‚  â”‚  browser_agent  â”‚    â”‚  system_agent   â”‚    â”‚  research_agent â”‚        â”‚
â”‚  â”‚       or        â”‚    â”‚       or        â”‚    â”‚                 â”‚        â”‚
â”‚  â”‚  aichat --macro â”‚    â”‚  aichat --macro â”‚    â”‚                 â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚           â”‚                      â”‚                                         â”‚
â”‚           â–¼                      â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚  â”‚     Chrome      â”‚    â”‚   Linux/macOS   â”‚                               â”‚
â”‚  â”‚   (Profile)     â”‚    â”‚    Commands     â”‚                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚    Venice.ai    â”‚
                         â”‚     GLM-4.7     â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Key Design Decisions

### 1. Worker Execution: Local CLI Commands

RQ workers invoke AIChat via local CLI commands (not HTTP API):

```python
# Worker runs aichat directly
subprocess.run(["aichat", "--agent", agent, "--session", session_id, message])
# or for macros:
subprocess.run(["aichat", "--macro", macro_name, *args])
```

### 2. State Management: Redis (Not Files)

All shared state lives in Redis:
- **Browser state** - Current URL, page title, session info
- **Pending confirmations** - Tasks awaiting user approval
- **Plan state** - Multi-step plan progress and results

### 3. Planning: Macros + Dynamic Planner (Hybrid)

| Task Type | Approach | Example |
|-----------|----------|---------|
| **Predefined workflow** | AIChat Macro | "Generate commit message", "Daily news summary" |
| **Common pattern** | AIChat Macro | "Buy X from Woolworths" (known steps) |
| **Novel/complex task** | Dynamic Planner | "Find houses under $800/week and compare to my requirements" |
| **Adaptive task** | Dynamic Planner | Tasks requiring re-planning based on results |

**Why both?**
- Macros are fast, predefined, no LLM overhead for planning
- Dynamic Planner handles novel tasks, can adapt when steps fail

---

## Workflow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            USER SENDS MESSAGE                                    â”‚
â”‚                         "Find houses under $800/week"                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              1. ROUTER                                           â”‚
â”‚                                                                                  â”‚
â”‚   Classify message â†’ Determine execution strategy                                â”‚
â”‚                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚   â”‚ Pattern Match   â”‚  â”‚ Complexity      â”‚  â”‚ Result                          â”‚â”‚
â”‚   â”‚                 â”‚  â”‚ Detection       â”‚  â”‚                                 â”‚â”‚
â”‚   â”‚ â€¢ Macro routes  â”‚  â”‚ â€¢ Multi-step?   â”‚  â”‚ â€¢ strategy: MACRO/AGENT/DYNAMIC â”‚â”‚
â”‚   â”‚ â€¢ Agent routes  â”‚  â”‚ â€¢ Novel task?   â”‚  â”‚ â€¢ target: agent/macro name      â”‚â”‚
â”‚   â”‚ â€¢ Confirm flags â”‚  â”‚ â€¢ Adaptive?     â”‚  â”‚ â€¢ requires_confirmation: bool   â”‚â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                  â”‚                  â”‚
                    â–¼                  â–¼                  â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   MACRO PATH      â”‚ â”‚  AGENT PATH   â”‚ â”‚  DYNAMIC PLAN PATH  â”‚
        â”‚                   â”‚ â”‚               â”‚ â”‚                     â”‚
        â”‚ "commit message"  â”‚ â”‚ "go to X.com" â”‚ â”‚ "find and compare"  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                   â”‚                    â”‚
                  â”‚                   â”‚                    â–¼
                  â”‚                   â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚                   â”‚         â”‚  2. DYNAMIC PLANNER â”‚
                  â”‚                   â”‚         â”‚                     â”‚
                  â”‚                   â”‚         â”‚  LLM decomposes     â”‚
                  â”‚                   â”‚         â”‚  task into steps:   â”‚
                  â”‚                   â”‚         â”‚                     â”‚
                  â”‚                   â”‚         â”‚  Step 1: browser    â”‚
                  â”‚                   â”‚         â”‚  Step 2: browser    â”‚
                  â”‚                   â”‚         â”‚  Step 3: research   â”‚
                  â”‚                   â”‚         â”‚                     â”‚
                  â”‚                   â”‚         â”‚  Save plan â†’ Redis  â”‚
                  â”‚                   â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                   â”‚                    â”‚
                  â–¼                   â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         3. CONFIRMATION CHECK                                    â”‚
â”‚                                                                                  â”‚
â”‚   requires_confirmation?                                                         â”‚
â”‚                                                                                  â”‚
â”‚   YES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚   â”‚                                    â”‚                                        â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                        â”‚
â”‚   â”‚  â”‚ Store pending task in Redis  â”‚  â”‚                                        â”‚
â”‚   â”‚  â”‚ Send: "Confirm? /confirm_X"  â”‚  â”‚                                        â”‚
â”‚   â”‚  â”‚ Wait for user response       â”‚  â”‚                                        â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                        â”‚
â”‚   â”‚                                    â”‚                                        â”‚
â”‚   â”‚  /confirm_X â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â–º Continue to Executor               â”‚
â”‚   â”‚  /cancel_X  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â–º Task cancelled                     â”‚
â”‚   â”‚  Timeout    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â–º Task expired                       â”‚
â”‚   â”‚                                    â”‚                                        â”‚
â”‚   NO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            4. EXECUTOR                                           â”‚
â”‚                                                                                  â”‚
â”‚   Enqueue task to appropriate RQ queue                                          â”‚
â”‚                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚   â”‚  browser_queue  â”‚  â”‚  default_queue  â”‚  â”‚   high_queue    â”‚                â”‚
â”‚   â”‚  (single worker)â”‚  â”‚  (multi worker) â”‚  â”‚  (priority)     â”‚                â”‚
â”‚   â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚                â”‚
â”‚   â”‚  browser_agent  â”‚  â”‚  system_agent   â”‚  â”‚  commands       â”‚                â”‚
â”‚   â”‚  tasks          â”‚  â”‚  research_agent â”‚  â”‚                 â”‚                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            5. RQ WORKER                                          â”‚
â”‚                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                         Execute Task                                     â”‚  â”‚
â”‚   â”‚                                                                          â”‚  â”‚
â”‚   â”‚   MACRO:                                                                 â”‚  â”‚
â”‚   â”‚   $ aichat --macro generate-commit-message                               â”‚  â”‚
â”‚   â”‚                                                                          â”‚  â”‚
â”‚   â”‚   AGENT:                                                                 â”‚  â”‚
â”‚   â”‚   $ aichat --agent browser_agent --session user_123 "go to google.com"   â”‚  â”‚
â”‚   â”‚                                                                          â”‚  â”‚
â”‚   â”‚   PLAN STEP:                                                             â”‚  â”‚
â”‚   â”‚   $ aichat --agent browser_agent "Step 1: search realestate.com.au"      â”‚  â”‚
â”‚   â”‚   â†’ Update step status in Redis                                          â”‚  â”‚
â”‚   â”‚   â†’ Enqueue next step if exists                                          â”‚  â”‚
â”‚   â”‚                                                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                      AIChat Agent Loop                                   â”‚  â”‚
â”‚   â”‚                                                                          â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚  â”‚
â”‚   â”‚   â”‚  Prompt  â”‚ â†’  â”‚   LLM    â”‚ â†’  â”‚  Tool    â”‚ â†’  â”‚  Result  â”‚         â”‚  â”‚
â”‚   â”‚   â”‚          â”‚    â”‚ (Venice) â”‚    â”‚  Call    â”‚    â”‚          â”‚         â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚  â”‚
â”‚   â”‚                                         â”‚                               â”‚  â”‚
â”‚   â”‚                                         â–¼                               â”‚  â”‚
â”‚   â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚  â”‚
â”‚   â”‚                              â”‚ browser_navigate â”‚                       â”‚  â”‚
â”‚   â”‚                              â”‚ browser_click    â”‚                       â”‚  â”‚
â”‚   â”‚                              â”‚ browser_type     â”‚                       â”‚  â”‚
â”‚   â”‚                              â”‚ shell_execute    â”‚                       â”‚  â”‚
â”‚   â”‚                              â”‚ file_read/write  â”‚                       â”‚  â”‚
â”‚   â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚  â”‚
â”‚   â”‚                                         â”‚                               â”‚  â”‚
â”‚   â”‚                                         â–¼                               â”‚  â”‚
â”‚   â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚  â”‚
â”‚   â”‚                              â”‚ Update Redis     â”‚                       â”‚  â”‚
â”‚   â”‚                              â”‚ browser state    â”‚                       â”‚  â”‚
â”‚   â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚  â”‚
â”‚   â”‚                                                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         6. SEND RESPONSE                                         â”‚
â”‚                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                                                          â”‚  â”‚
â”‚   â”‚   Text Response:                                                         â”‚  â”‚
â”‚   â”‚   send_message(chat_id, response_text)                                   â”‚  â”‚
â”‚   â”‚                                                                          â”‚  â”‚
â”‚   â”‚   Image Response (screenshot):                                           â”‚  â”‚
â”‚   â”‚   send_photo(chat_id, image_path, caption)                               â”‚  â”‚
â”‚   â”‚                                                                          â”‚  â”‚
â”‚   â”‚   Plan Progress:                                                         â”‚  â”‚
â”‚   â”‚   "âœ… Step 1 complete"                                                   â”‚  â”‚
â”‚   â”‚   "ðŸ”„ Step 2: Extracting listings..."                                    â”‚  â”‚
â”‚   â”‚   "âœ… All steps completed!"                                              â”‚  â”‚
â”‚   â”‚                                                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚      USER RECEIVES        â”‚
                        â”‚        RESPONSE           â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Workflow: Dynamic Plan Execution (Detail)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DYNAMIC PLAN: "Find 3BR houses in Richmond under $800/week and compare them"   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           PLANNER (LLM)                                          â”‚
â”‚                                                                                  â”‚
â”‚   Prompt: "Break down this task into steps..."                                   â”‚
â”‚                                                                                  â”‚
â”‚   Response (JSON):                                                               â”‚
â”‚   [                                                                              â”‚
â”‚     {"order": 1, "agent": "browser_agent",                                       â”‚
â”‚      "action": "Navigate to realestate.com.au"},                                 â”‚
â”‚     {"order": 2, "agent": "browser_agent",                                       â”‚
â”‚      "action": "Search for 3BR in Richmond under $800/week", "depends_on": [1]}, â”‚
â”‚     {"order": 3, "agent": "browser_agent",                                       â”‚
â”‚      "action": "Extract top 5 listing details", "depends_on": [2]},              â”‚
â”‚     {"order": 4, "agent": "research_agent",                                      â”‚
â”‚      "action": "Compare listings and recommend best options", "depends_on": [3]} â”‚
â”‚   ]                                                                              â”‚
â”‚                                                                                  â”‚
â”‚   â†’ Save to Redis: plan:plan_123_1706012345                                      â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         STEP EXECUTION LOOP                                      â”‚
â”‚                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 1: browser_agent                                              [RUN]â”‚   â”‚
â”‚  â”‚ "Navigate to realestate.com.au"                                         â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚ â†’ aichat --agent browser_agent "Navigate to realestate.com.au"          â”‚   â”‚
â”‚  â”‚ â†’ Tool: browser_navigate("https://realestate.com.au")                   â”‚   â”‚
â”‚  â”‚ â†’ Result: "Navigated to: Real Estate Australia"                         â”‚   â”‚
â”‚  â”‚ â†’ Update Redis: step 1 = COMPLETED                                      â”‚   â”‚
â”‚  â”‚ â†’ Enqueue next step                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                       â”‚                                         â”‚
â”‚                                       â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 2: browser_agent                                              [RUN]â”‚   â”‚
â”‚  â”‚ "Search for 3BR in Richmond under $800/week"                            â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚ â†’ aichat --agent browser_agent "Search for 3BR..."                      â”‚   â”‚
â”‚  â”‚ â†’ Tools: browser_click, browser_type, browser_screenshot                â”‚   â”‚
â”‚  â”‚ â†’ Result: "Found 15 listings matching criteria" + [IMAGE:/tmp/ss.png]   â”‚   â”‚
â”‚  â”‚ â†’ Update Redis: step 2 = COMPLETED                                      â”‚   â”‚
â”‚  â”‚ â†’ Send screenshot to user                                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                       â”‚                                         â”‚
â”‚                                       â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 3: browser_agent                                              [RUN]â”‚   â”‚
â”‚  â”‚ "Extract top 5 listing details"                                         â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚ â†’ aichat --agent browser_agent "Extract top 5..."                       â”‚   â”‚
â”‚  â”‚ â†’ Tools: browser_read_text, browser_scroll                              â”‚   â”‚
â”‚  â”‚ â†’ Result: JSON with 5 listings (address, price, features)               â”‚   â”‚
â”‚  â”‚ â†’ Update Redis: step 3 = COMPLETED, store result                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                       â”‚                                         â”‚
â”‚                                       â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 4: research_agent                                             [RUN]â”‚   â”‚
â”‚  â”‚ "Compare listings and recommend best options"                           â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚ â†’ Receives output from Step 3                                           â”‚   â”‚
â”‚  â”‚ â†’ aichat --agent research_agent "Compare these listings..."             â”‚   â”‚
â”‚  â”‚ â†’ Result: Structured comparison with recommendation                     â”‚   â”‚
â”‚  â”‚ â†’ Update Redis: step 4 = COMPLETED                                      â”‚   â”‚
â”‚  â”‚ â†’ Send final summary to user                                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                       â”‚                                         â”‚
â”‚                                       â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                          PLAN COMPLETED                                  â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚ "âœ… All steps completed!"                                                â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚ Final output sent to user:                                               â”‚   â”‚
â”‚  â”‚ - Screenshot of search results                                          â”‚   â”‚
â”‚  â”‚ - Comparison table                                                       â”‚   â”‚
â”‚  â”‚ - Top recommendation                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Workflow: Error Handling & Re-planning

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          STEP FAILURE SCENARIO                                   â”‚
â”‚                                                                                  â”‚
â”‚  Step 2: browser_agent                                                [FAILED]  â”‚
â”‚  "Search for 3BR in Richmond under $800/week"                                   â”‚
â”‚                                                                                  â”‚
â”‚  Error: "Element not found: search button"                                       â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          RE-PLANNING OPTIONS                                     â”‚
â”‚                                                                                  â”‚
â”‚  Option A: Retry with different approach                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Call LLM: "Step 2 failed with error: Element not found.                 â”‚   â”‚
â”‚  â”‚            Suggest alternative approach."                                â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚ LLM Response: "Try scrolling page first, or use keyboard shortcut"      â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚ â†’ Insert new step 2b: "Scroll to find search, use Cmd+F"                â”‚   â”‚
â”‚  â”‚ â†’ Retry                                                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                  â”‚
â”‚  Option B: Skip dependent steps                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Mark dependent steps (3, 4) as SKIPPED                                  â”‚   â”‚
â”‚  â”‚ Notify user: "Step 2 failed. Steps 3-4 skipped."                        â”‚   â”‚
â”‚  â”‚ End plan with partial completion                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                  â”‚
â”‚  Option C: Ask user for guidance                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Send to user: "Step 2 failed: Element not found.                        â”‚   â”‚
â”‚  â”‚                                                                          â”‚   â”‚
â”‚  â”‚                Options:                                                  â”‚   â”‚
â”‚  â”‚                /retry - Try again                                        â”‚   â”‚
â”‚  â”‚                /skip - Skip this step                                    â”‚   â”‚
â”‚  â”‚                /abort - Cancel entire plan"                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Development Phases

### Phase 0: Prerequisites & Setup (Day 1)

**Goal**: Set up llm-functions and verify AIChat agent/tool system works

```bash
# 1. Clone llm-functions into project
cd ~/aichat-telegram-bot
git clone https://github.com/sigoden/llm-functions functions

# 2. Install dependencies
cd functions
npm install        # For JS tools
pip install playwright  # For browser tools

# 3. Link to AIChat
argc link-to-aichat

# 4. Verify AIChat can see functions
aichat --info | grep functions_dir
```

**Deliverables**:
- [ ] llm-functions cloned and linked
- [ ] Basic tools working (`execute_command.sh`)
- [ ] AIChat can call functions

---

### Phase 1: Browser Agent with Playwright Tools (Days 2-4)

**Goal**: Create AIChat agent with Playwright-based browser tools

#### 1.1 Create Browser Tools

```
functions/
â”œâ”€â”€ tools/
â”‚   â”œâ”€â”€ browser_navigate.py      # Navigate to URL
â”‚   â”œâ”€â”€ browser_click.py         # Click element
â”‚   â”œâ”€â”€ browser_type.py          # Type into field
â”‚   â”œâ”€â”€ browser_screenshot.py    # Take screenshot
â”‚   â”œâ”€â”€ browser_read_text.py     # Extract text
â”‚   â”œâ”€â”€ browser_get_elements.py  # List interactive elements
â”‚   â””â”€â”€ browser_scroll.py        # Scroll page
```

**Example: browser_navigate.py** (with Redis state)

```python
import os
import redis
from playwright.sync_api import sync_playwright

# Redis for browser state
redis_client = redis.Redis(host='localhost', port=6379, db=0)

def get_browser_context():
    """Get or create persistent browser context."""
    playwright = sync_playwright().start()
    browser = playwright.chromium.launch_persistent_context(
        user_data_dir=os.environ.get("CHROME_PROFILE", "~/.config/agent-chrome-profile"),
        headless=os.environ.get("BROWSER_HEADLESS", "true").lower() == "true",
    )
    return browser

def run(url: str):
    """Navigate the browser to a URL.

    Args:
        url: The URL to navigate to (e.g., "https://woolworths.com.au")
    """
    browser = get_browser_context()
    page = browser.pages[0] if browser.pages else browser.new_page()
    page.goto(url, wait_until="networkidle")

    # Save state to Redis
    user_id = os.environ.get("USER_ID", "default")
    redis_client.hset(f"browser:{user_id}", mapping={
        "url": page.url,
        "title": page.title()
    })

    return f"Navigated to: {page.title()} ({page.url})"
```

**Example: browser_screenshot.py**

```python
import os
import base64
from playwright.sync_api import sync_playwright

def run(full_page: bool = False):
    """Take a screenshot of the current browser page.

    Args:
        full_page: Whether to capture the full page or just viewport
    """
    # ... get browser context ...

    screenshot_path = "/tmp/screenshot.png"
    page.screenshot(path=screenshot_path, full_page=full_page)

    # Return base64 for Telegram
    with open(screenshot_path, "rb") as f:
        img_base64 = base64.b64encode(f.read()).decode()

    return {"image": img_base64, "path": screenshot_path}
```

#### 1.2 Create Browser Agent

```
functions/
â””â”€â”€ agents/
    â””â”€â”€ browser_agent/
        â”œâ”€â”€ index.yaml           # Agent definition
        â”œâ”€â”€ tools.txt            # Tools to include
        â””â”€â”€ functions.json       # Auto-generated
```

**agents/browser_agent/index.yaml**

```yaml
name: BrowserAgent
description: Controls a web browser to navigate, interact, and extract information
version: 0.1.0

instructions: |
  You are a browser automation agent. You control a real Chrome browser with saved logins.

  ## Your Capabilities
  - Navigate to any URL
  - Click buttons, links, and elements
  - Type text into input fields
  - Take screenshots to show progress
  - Extract text from pages
  - Scroll to find content

  ## Important Rules
  1. Always take a screenshot after major actions to verify results
  2. When filling forms, the browser has saved passwords - just click login buttons
  3. If an element isn't found, try scrolling or waiting
  4. Report what you see after each action

  ## Workflow
  1. Navigate to the target page
  2. Take screenshot to verify
  3. Interact with elements as needed
  4. Take final screenshot to confirm result

conversation_starters:
  - Go to woolworths.com.au
  - Search for milk on the current page
  - Take a screenshot

variables:
  - name: chrome_profile
    description: Path to Chrome profile directory
```

**agents/browser_agent/tools.txt**

```
browser_navigate.py
browser_click.py
browser_type.py
browser_screenshot.py
browser_read_text.py
browser_get_elements.py
browser_scroll.py
```

#### 1.3 Test Browser Agent

```bash
# Build the agent
cd functions
argc build

# Test directly
aichat --agent browser_agent "go to google.com and take a screenshot"
```

**Deliverables**:
- [ ] 7 browser tools created and tested
- [ ] browser_agent configured
- [ ] Browser state stored in Redis
- [ ] Can navigate and screenshot via CLI

---

### Phase 2: System Agent (Days 5-6)

**Goal**: Create agent for shell commands and file operations

#### 2.1 Create System Tools

```
functions/
â”œâ”€â”€ tools/
â”‚   â”œâ”€â”€ shell_execute.sh         # Execute shell command (with blocklist)
â”‚   â”œâ”€â”€ file_read.sh             # Read file content
â”‚   â”œâ”€â”€ file_write.sh            # Write to file
â”‚   â”œâ”€â”€ file_list.sh             # List directory
â”‚   â”œâ”€â”€ process_list.sh          # List running processes
â”‚   â””â”€â”€ cron_schedule.sh         # Schedule a task
```

**Example: shell_execute.sh**

```bash
#!/usr/bin/env bash
set -e

# @describe Execute a shell command safely.
# @option --command! The command to execute.

# Blocked dangerous commands
BLOCKLIST=(
    "rm -rf /"
    "rm -rf /*"
    "dd if="
    "mkfs"
    "> /dev/"
    "chmod 777 /"
)

main() {
    # Check blocklist
    for blocked in "${BLOCKLIST[@]}"; do
        if [[ "$argc_command" == *"$blocked"* ]]; then
            echo "ERROR: Command blocked for safety: $blocked" >> "$LLM_OUTPUT"
            exit 1
        fi
    done

    # Execute command
    eval "$argc_command" >> "$LLM_OUTPUT" 2>&1
}

eval "$(argc --argc-eval "$0" "$@")"
```

#### 2.2 Create System Agent

**agents/system_agent/index.yaml**

```yaml
name: SystemAgent
description: Executes system commands and manages files
version: 0.1.0

instructions: |
  You are a system administration agent for a Linux/macOS home server.

  ## Your Capabilities
  - Execute shell commands
  - Read, write, and list files
  - Check running processes
  - Schedule tasks with cron

  ## Safety Rules
  1. NEVER execute destructive commands (rm -rf /, dd, mkfs)
  2. Ask for confirmation before modifying system files
  3. Always show command output to the user
  4. For unknown commands, explain what they do first

  ## Allowed Paths
  - /home/user
  - /tmp
  - ~/Documents, ~/Downloads

conversation_starters:
  - List files in my Documents folder
  - Check disk usage
  - Show running processes
```

**Deliverables**:
- [ ] 6 system tools created
- [ ] system_agent configured
- [ ] Safety blocklist implemented

---

### Phase 3: Gateway Integration (Days 7-10)

**Goal**: Build Gateway that routes to AIChat agents via RQ

#### 3.1 Gateway Components

```
app/
â”œâ”€â”€ gateway/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ router.py          # Classify requests â†’ agent or macro
â”‚   â”œâ”€â”€ planner.py         # Dynamic planning for complex tasks
â”‚   â”œâ”€â”€ executor.py        # Enqueue tasks to RQ
â”‚   â””â”€â”€ confirmation.py    # Handle user confirmations (Redis-backed)
```

**app/gateway/router.py**

```python
"""
Router: Classifies incoming messages and determines execution strategy.
"""
import re
from enum import Enum
from dataclasses import dataclass
from typing import Optional

class ExecutionStrategy(Enum):
    MACRO = "macro"           # Use predefined AIChat macro
    AGENT = "agent"           # Use single agent directly
    DYNAMIC_PLAN = "dynamic"  # Use dynamic planner for complex tasks

@dataclass
class RouteResult:
    strategy: ExecutionStrategy
    target: str               # Macro name or agent name
    requires_confirmation: bool
    requires_planning: bool   # True if dynamic planner needed
    confidence: float

# Pattern-based routing rules
MACRO_ROUTES = [
    # Predefined workflows â†’ use macros
    (r'\b(commit|git commit)\b', "generate-commit-message", False),
    (r'\b(daily news|news summary)\b', "daily-news-summary", False),
]

AGENT_ROUTES = [
    # Simple tasks â†’ direct agent
    (r'\b(navigate|go to|open|visit)\b.*\.(com|org|net|au)', "browser_agent", False),
    (r'\b(screenshot|take screenshot)\b', "browser_agent", False),
    (r'\b(disk usage|df|free space)\b', "system_agent", False),
    (r'\b(list files|ls|directory)\b', "system_agent", False),
]

COMPLEX_PATTERNS = [
    # Complex tasks â†’ dynamic planner
    r'\b(find|search|compare|analyze).*and.*(save|summarize|compare)\b',
    r'\b(research|investigate)\b.*\b(then|and)\b',
    r'\bstep.?by.?step\b',
]

CONFIRMATION_PATTERNS = [
    r'\b(buy|order|purchase|checkout|pay)\b',
    r'\b(delete|remove|rm)\b',
    r'\b(send|submit|post)\b',
]

class Router:
    """Routes incoming requests to appropriate execution strategy."""

    def classify(self, message: str) -> RouteResult:
        message_lower = message.lower()

        requires_confirmation = any(
            re.search(p, message_lower) for p in CONFIRMATION_PATTERNS
        )

        # Check for macro routes first (predefined workflows)
        for pattern, macro_name, needs_confirm in MACRO_ROUTES:
            if re.search(pattern, message_lower):
                return RouteResult(
                    strategy=ExecutionStrategy.MACRO,
                    target=macro_name,
                    requires_confirmation=needs_confirm or requires_confirmation,
                    requires_planning=False,
                    confidence=0.95
                )

        # Check if task is complex (needs dynamic planning)
        is_complex = any(re.search(p, message_lower) for p in COMPLEX_PATTERNS)

        if is_complex:
            return RouteResult(
                strategy=ExecutionStrategy.DYNAMIC_PLAN,
                target="planner",
                requires_confirmation=requires_confirmation,
                requires_planning=True,
                confidence=0.8
            )

        # Simple tasks â†’ direct agent
        for pattern, agent_name, needs_confirm in AGENT_ROUTES:
            if re.search(pattern, message_lower):
                return RouteResult(
                    strategy=ExecutionStrategy.AGENT,
                    target=agent_name,
                    requires_confirmation=needs_confirm or requires_confirmation,
                    requires_planning=False,
                    confidence=0.9
                )

        # Default: use dynamic planner for unknown tasks
        return RouteResult(
            strategy=ExecutionStrategy.DYNAMIC_PLAN,
            target="planner",
            requires_confirmation=requires_confirmation,
            requires_planning=True,
            confidence=0.5
        )
```

**app/gateway/planner.py**

```python
"""
Dynamic Planner: LLM-based planning for novel/complex tasks.

Uses AIChat to decompose tasks, track progress, and adapt plans.
"""
import json
import subprocess
import logging
from dataclasses import dataclass, field
from typing import List, Optional
from enum import Enum
import redis

logger = logging.getLogger(__name__)

class StepStatus(Enum):
    PENDING = "pending"
    RUNNING = "running"
    COMPLETED = "completed"
    FAILED = "failed"
    SKIPPED = "skipped"

@dataclass
class Step:
    order: int
    agent: str
    action: str
    status: StepStatus = StepStatus.PENDING
    result: Optional[str] = None
    error: Optional[str] = None
    depends_on: List[int] = field(default_factory=list)

@dataclass
class Plan:
    plan_id: str
    goal: str
    steps: List[Step]
    checkpoints: List[int]  # Steps requiring confirmation
    current_step: int = 0
    status: str = "active"

class DynamicPlanner:
    """Creates and manages execution plans for complex tasks."""

    PLANNING_PROMPT = '''You are a task planner. Break down this task into steps.

Available agents:
- browser_agent: Navigate websites, click, type, screenshot, extract text
- system_agent: Execute shell commands, read/write files
- research_agent: Analyze, summarize, compare information

Task: {task}

Return a JSON array of steps:
[
  {{"order": 1, "agent": "browser_agent", "action": "description of what to do"}},
  {{"order": 2, "agent": "research_agent", "action": "...", "depends_on": [1]}}
]

Rules:
- Each step should be atomic (one clear action)
- Use depends_on to specify step dependencies
- browser_agent for any web interaction
- system_agent for file/shell operations
- research_agent for analysis/summarization

Return ONLY the JSON array, no other text.'''

    def __init__(self):
        self.redis = redis.Redis(host='localhost', port=6379, db=0)

    def create_plan(self, task: str, user_id: int) -> Plan:
        """Use LLM to decompose task into steps."""

        # Call AIChat for planning
        prompt = self.PLANNING_PROMPT.format(task=task)
        result = subprocess.run(
            ["aichat", prompt],
            capture_output=True,
            text=True,
            timeout=60
        )

        try:
            steps_data = json.loads(result.stdout.strip())
            steps = [
                Step(
                    order=s["order"],
                    agent=s["agent"],
                    action=s["action"],
                    depends_on=s.get("depends_on", [])
                )
                for s in steps_data
            ]
        except (json.JSONDecodeError, KeyError) as e:
            logger.error(f"Failed to parse plan: {e}")
            # Fallback: single-step plan
            steps = [Step(order=1, agent="browser_agent", action=task)]

        plan = Plan(
            plan_id=f"plan_{user_id}_{int(time.time())}",
            goal=task,
            steps=steps,
            checkpoints=self._identify_checkpoints(steps)
        )

        # Store plan in Redis
        self._save_plan(plan)

        return plan

    def _identify_checkpoints(self, steps: List[Step]) -> List[int]:
        """Find steps that need user confirmation."""
        checkpoint_words = ["checkout", "purchase", "delete", "send", "submit", "pay"]
        return [
            s.order for s in steps
            if any(word in s.action.lower() for word in checkpoint_words)
        ]

    def _save_plan(self, plan: Plan) -> None:
        """Save plan state to Redis."""
        self.redis.set(
            f"plan:{plan.plan_id}",
            json.dumps({
                "plan_id": plan.plan_id,
                "goal": plan.goal,
                "steps": [
                    {
                        "order": s.order,
                        "agent": s.agent,
                        "action": s.action,
                        "status": s.status.value,
                        "result": s.result,
                        "error": s.error,
                        "depends_on": s.depends_on
                    }
                    for s in plan.steps
                ],
                "checkpoints": plan.checkpoints,
                "current_step": plan.current_step,
                "status": plan.status
            }),
            ex=3600  # 1 hour TTL
        )

    def get_plan(self, plan_id: str) -> Optional[Plan]:
        """Load plan from Redis."""
        data = self.redis.get(f"plan:{plan_id}")
        if not data:
            return None
        # ... deserialize ...

    def update_step(self, plan_id: str, step_order: int,
                    status: StepStatus, result: str = None, error: str = None) -> None:
        """Update step status and re-plan if needed."""
        plan = self.get_plan(plan_id)
        if not plan:
            return

        for step in plan.steps:
            if step.order == step_order:
                step.status = status
                step.result = result
                step.error = error
                break

        # If step failed, consider re-planning
        if status == StepStatus.FAILED:
            self._handle_failure(plan, step_order, error)

        self._save_plan(plan)

    def _handle_failure(self, plan: Plan, failed_step: int, error: str) -> None:
        """Re-plan after a step failure."""
        logger.info(f"Step {failed_step} failed, considering re-plan")

        # Could call AIChat to generate alternative steps
        # For now, just mark dependent steps as skipped
        for step in plan.steps:
            if failed_step in step.depends_on:
                step.status = StepStatus.SKIPPED

    def get_next_step(self, plan_id: str) -> Optional[Step]:
        """Get next executable step (dependencies satisfied)."""
        plan = self.get_plan(plan_id)
        if not plan:
            return None

        completed = {s.order for s in plan.steps if s.status == StepStatus.COMPLETED}

        for step in plan.steps:
            if step.status != StepStatus.PENDING:
                continue
            if all(dep in completed for dep in step.depends_on):
                return step

        return None
```

**app/gateway/executor.py**

```python
"""
Executor: Enqueues tasks to RQ workers.
"""
from rq import Queue
from redis import Redis
from app.config import settings
from app.tasks.agent_tasks import run_agent_task, run_macro_task, run_plan_step
from app.gateway.router import ExecutionStrategy, RouteResult

class Executor:
    """Executes tasks via RQ workers."""

    def __init__(self):
        self.redis = Redis(
            host=settings.REDIS_HOST,
            port=settings.REDIS_PORT
        )
        self.queues = {
            "browser": Queue("browser", connection=self.redis),
            "default": Queue("default", connection=self.redis),
            "high": Queue("high", connection=self.redis),
        }

    def execute(
        self,
        route: RouteResult,
        message: str,
        user_id: int,
        chat_id: int,
        session_id: str,
        plan_id: str = None
    ) -> str:
        """Execute based on routing result."""

        if route.strategy == ExecutionStrategy.MACRO:
            return self._enqueue_macro(route.target, message, user_id, chat_id)

        elif route.strategy == ExecutionStrategy.AGENT:
            return self._enqueue_agent(route.target, message, user_id, chat_id, session_id)

        elif route.strategy == ExecutionStrategy.DYNAMIC_PLAN:
            return self._enqueue_plan(message, user_id, chat_id, session_id)

    def _enqueue_macro(self, macro: str, message: str, user_id: int, chat_id: int) -> str:
        """Enqueue a macro execution."""
        job = self.queues["default"].enqueue(
            run_macro_task,
            macro=macro,
            args=message,
            user_id=user_id,
            chat_id=chat_id,
            job_timeout=settings.JOB_TIMEOUT,
        )
        return job.id

    def _enqueue_agent(self, agent: str, message: str, user_id: int,
                       chat_id: int, session_id: str) -> str:
        """Enqueue a single agent task."""
        queue = self.queues["browser"] if agent == "browser_agent" else self.queues["default"]

        job = queue.enqueue(
            run_agent_task,
            agent=agent,
            message=message,
            user_id=user_id,
            chat_id=chat_id,
            session_id=session_id,
            job_timeout=settings.JOB_TIMEOUT,
        )
        return job.id

    def _enqueue_plan(self, message: str, user_id: int, chat_id: int, session_id: str) -> str:
        """Create plan and enqueue first step."""
        from app.gateway.planner import DynamicPlanner

        planner = DynamicPlanner()
        plan = planner.create_plan(message, user_id)

        # Enqueue plan execution
        job = self.queues["default"].enqueue(
            run_plan_step,
            plan_id=plan.plan_id,
            user_id=user_id,
            chat_id=chat_id,
            session_id=session_id,
            job_timeout=settings.JOB_TIMEOUT,
        )
        return job.id
```

#### 3.2 Agent Task Runner

**app/tasks/agent_tasks.py**

```python
"""
RQ tasks that invoke AIChat agents and macros.
"""
import subprocess
import os
import re
import logging
from app.services.telegram import send_message, send_photo
from app.config import settings

logger = logging.getLogger(__name__)

def run_agent_task(
    agent: str,
    message: str,
    user_id: int,
    chat_id: int,
    session_id: str
) -> dict:
    """
    Run an AIChat agent via CLI.
    """
    env = os.environ.copy()
    env["USER_ID"] = str(user_id)

    cmd = [
        "aichat",
        "--agent", agent,
        "--session", session_id,
        message
    ]

    try:
        result = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            env=env,
            timeout=settings.JOB_TIMEOUT
        )

        response_text = result.stdout.strip()

        # Handle image responses
        if "[IMAGE:" in response_text:
            img_path = extract_image_path(response_text)
            if img_path and os.path.exists(img_path):
                send_photo(chat_id, img_path, caption=clean_text(response_text))
            else:
                send_message(chat_id, response_text)
        else:
            send_message(chat_id, response_text)

        return {"success": result.returncode == 0, "response": response_text}

    except subprocess.TimeoutExpired:
        send_message(chat_id, "â±ï¸ Task timed out. Please try again.")
        return {"success": False, "error": "timeout"}

    except Exception as e:
        logger.exception(f"Agent task failed: {agent}")
        send_message(chat_id, f"âŒ Error: {str(e)}")
        return {"success": False, "error": str(e)}


def run_macro_task(
    macro: str,
    args: str,
    user_id: int,
    chat_id: int
) -> dict:
    """
    Run an AIChat macro via CLI.
    """
    cmd = ["aichat", "--macro", macro] + args.split()

    try:
        result = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            timeout=settings.JOB_TIMEOUT
        )

        send_message(chat_id, result.stdout.strip())
        return {"success": result.returncode == 0, "response": result.stdout}

    except Exception as e:
        logger.exception(f"Macro task failed: {macro}")
        send_message(chat_id, f"âŒ Error: {str(e)}")
        return {"success": False, "error": str(e)}


def run_plan_step(
    plan_id: str,
    user_id: int,
    chat_id: int,
    session_id: str
) -> dict:
    """
    Execute the next step in a dynamic plan.
    """
    from app.gateway.planner import DynamicPlanner, StepStatus
    from app.tasks.queues import default_queue

    planner = DynamicPlanner()
    step = planner.get_next_step(plan_id)

    if not step:
        send_message(chat_id, "âœ… Plan completed!")
        return {"success": True, "status": "completed"}

    # Check if this step needs confirmation
    plan = planner.get_plan(plan_id)
    if step.order in plan.checkpoints:
        # Store pending and ask for confirmation
        # (handled by confirmation handler)
        pass

    # Execute the step
    send_message(chat_id, f"ðŸ”„ Step {step.order}: {step.action}")

    result = run_agent_task(
        agent=step.agent,
        message=step.action,
        user_id=user_id,
        chat_id=chat_id,
        session_id=session_id
    )

    # Update step status
    if result["success"]:
        planner.update_step(plan_id, step.order, StepStatus.COMPLETED, result.get("response"))
    else:
        planner.update_step(plan_id, step.order, StepStatus.FAILED, error=result.get("error"))

    # Enqueue next step
    next_step = planner.get_next_step(plan_id)
    if next_step:
        default_queue.enqueue(
            run_plan_step,
            plan_id=plan_id,
            user_id=user_id,
            chat_id=chat_id,
            session_id=session_id
        )
    else:
        send_message(chat_id, "âœ… All steps completed!")

    return result


def extract_image_path(text: str) -> str:
    """Extract image path from response text."""
    match = re.search(r'\[IMAGE:([^\]]+)\]', text)
    return match.group(1) if match else None


def clean_text(text: str) -> str:
    """Remove image markers from text."""
    return re.sub(r'\[IMAGE:[^\]]+\]', '', text).strip()
```

#### 3.3 Confirmation Handler (Redis-backed)

**app/gateway/confirmation.py**

```python
"""
Handles user confirmations for sensitive actions.
Uses Redis for persistence (survives bot restarts).
"""
import json
import uuid
from datetime import datetime, timedelta
from typing import Optional
from dataclasses import dataclass
import redis

from app.config import settings

@dataclass
class PendingTask:
    task_id: str
    user_id: int
    chat_id: int
    message: str
    agent: str
    plan_id: Optional[str]
    created_at: str
    expires_at: str

class ConfirmationHandler:
    """Manages pending confirmations in Redis."""

    def __init__(self):
        self.redis = redis.Redis(
            host=settings.REDIS_HOST,
            port=settings.REDIS_PORT,
            db=settings.REDIS_DB
        )
        self.timeout_minutes = 5

    def create_pending_task(
        self,
        user_id: int,
        chat_id: int,
        message: str,
        agent: str,
        plan_id: str = None
    ) -> str:
        """Create a pending task awaiting confirmation."""
        task_id = str(uuid.uuid4())[:8]
        now = datetime.utcnow()
        expires = now + timedelta(minutes=self.timeout_minutes)

        task = PendingTask(
            task_id=task_id,
            user_id=user_id,
            chat_id=chat_id,
            message=message,
            agent=agent,
            plan_id=plan_id,
            created_at=now.isoformat(),
            expires_at=expires.isoformat()
        )

        # Store in Redis with TTL
        self.redis.setex(
            f"confirm:{task_id}",
            self.timeout_minutes * 60,
            json.dumps(task.__dict__)
        )

        return task_id

    def confirm(self, task_id: str, user_id: int) -> Optional[PendingTask]:
        """Confirm a pending task."""
        data = self.redis.get(f"confirm:{task_id}")
        if not data:
            return None

        task_data = json.loads(data)
        if task_data["user_id"] != user_id:
            return None

        # Delete from Redis
        self.redis.delete(f"confirm:{task_id}")

        return PendingTask(**task_data)

    def cancel(self, task_id: str, user_id: int) -> bool:
        """Cancel a pending task."""
        data = self.redis.get(f"confirm:{task_id}")
        if not data:
            return False

        task_data = json.loads(data)
        if task_data["user_id"] != user_id:
            return False

        self.redis.delete(f"confirm:{task_id}")
        return True
```

#### 3.4 Update Bot Handlers

**app/bot/handlers.py** (modified)

```python
from app.gateway.router import Router, ExecutionStrategy
from app.gateway.executor import Executor
from app.gateway.confirmation import ConfirmationHandler

router = Router()
executor = Executor()
confirmation_handler = ConfirmationHandler()

async def message_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Main message handler - routes through Gateway."""
    user_id = update.effective_user.id
    chat_id = update.effective_chat.id
    message = update.message.text

    if not is_allowed(user_id):
        await update.message.reply_text("Access denied.")
        return

    # Show typing indicator
    await context.bot.send_chat_action(chat_id=chat_id, action="typing")

    # Classify the message
    route = router.classify(message)

    # Check if confirmation is needed
    if route.requires_confirmation:
        task_id = confirmation_handler.create_pending_task(
            user_id=user_id,
            chat_id=chat_id,
            message=message,
            agent=route.target
        )

        strategy_desc = {
            ExecutionStrategy.MACRO: f"Macro: {route.target}",
            ExecutionStrategy.AGENT: f"Agent: {route.target}",
            ExecutionStrategy.DYNAMIC_PLAN: "Dynamic plan (multi-step)"
        }

        await update.message.reply_text(
            f"âš ï¸ This action requires confirmation:\n\n"
            f"**Task**: {message}\n"
            f"**Strategy**: {strategy_desc[route.strategy]}\n\n"
            f"Reply /confirm_{task_id} to proceed or /cancel_{task_id} to abort."
        )
        return

    # Execute the task
    session_id = f"user_{user_id}"
    job_id = executor.execute(
        route=route,
        message=message,
        user_id=user_id,
        chat_id=chat_id,
        session_id=session_id
    )

    status_msg = {
        ExecutionStrategy.MACRO: f"ðŸ”„ Running macro: {route.target}",
        ExecutionStrategy.AGENT: f"ðŸ¤– Processing with {route.target}",
        ExecutionStrategy.DYNAMIC_PLAN: "ðŸ“‹ Creating execution plan..."
    }

    await update.message.reply_text(f"{status_msg[route.strategy]}\nJob: {job_id[:8]}")
```

**Deliverables**:
- [ ] Router classifies â†’ macro, agent, or dynamic plan
- [ ] Executor enqueues appropriate task type
- [ ] Dynamic planner creates multi-step plans
- [ ] Plan state persisted in Redis
- [ ] Confirmation handler uses Redis
- [ ] Results sent back to Telegram

---

### Phase 4: AIChat Macros for Common Workflows (Days 11-12)

**Goal**: Create macros for predefined workflows

#### 4.1 Example Macros

**~/.config/aichat/macros/generate-commit-message.yaml**

```yaml
steps:
  - .file `git diff --staged` -- Generate a concise git commit message for these changes
```

**~/.config/aichat/macros/daily-news-summary.yaml**

```yaml
variables:
  - name: topic
    default: technology
steps:
  - .agent browser_agent
  - 'Go to news.google.com and search for {{topic}} news'
  - .agent research_agent
  - .file %%
  - 'Summarize the top 5 news stories in bullet points'
```

**~/.config/aichat/macros/shop-woolworths.yaml**

```yaml
variables:
  - name: item
    rest: true
steps:
  - .agent browser_agent
  - 'Go to woolworths.com.au, search for {{item}}, and show me the results'
```

**Deliverables**:
- [ ] 3-5 common macros created
- [ ] Macros tested via CLI
- [ ] Router maps to macros correctly

---

### Phase 5: Research Agent & Multi-Agent Workflows (Days 13-14)

**Goal**: Add research agent for analysis tasks

#### 5.1 Research Agent

**agents/research_agent/index.yaml**

```yaml
name: ResearchAgent
description: Analyzes, summarizes, and compares information
version: 0.1.0

instructions: |
  You are a research assistant. You analyze and summarize information.

  ## Your Capabilities
  - Summarize long text
  - Compare multiple items (products, listings, options)
  - Extract key information
  - Create structured reports

  ## Output Format
  - Use bullet points for lists
  - Use markdown formatting
  - Be concise but comprehensive

conversation_starters:
  - Summarize this article
  - Compare these rental listings
  - What are the key points?
```

**Deliverables**:
- [ ] Research agent created
- [ ] Works in multi-agent macros
- [ ] Can receive input from other agents

---

### Phase 6: Browser Session Management (Days 15-16)

**Goal**: Persistent Chrome profile with saved logins

#### 6.1 Browser State Service

**app/services/browser_state.py**

```python
"""
Browser state management via Redis.
"""
import redis
from typing import Optional
from app.config import settings

class BrowserState:
    """Manages browser state in Redis."""

    def __init__(self):
        self.redis = redis.Redis(
            host=settings.REDIS_HOST,
            port=settings.REDIS_PORT
        )

    def save(self, user_id: int, url: str, title: str, cookies: dict = None) -> None:
        """Save browser state."""
        self.redis.hset(f"browser:{user_id}", mapping={
            "url": url,
            "title": title
        })
        if cookies:
            self.redis.set(f"browser:{user_id}:cookies", json.dumps(cookies))

    def get(self, user_id: int) -> Optional[dict]:
        """Get browser state."""
        data = self.redis.hgetall(f"browser:{user_id}")
        if not data:
            return None
        return {k.decode(): v.decode() for k, v in data.items()}

    def clear(self, user_id: int) -> None:
        """Clear browser state."""
        self.redis.delete(f"browser:{user_id}")
        self.redis.delete(f"browser:{user_id}:cookies")
```

#### 6.2 Setup Script

**scripts/setup_chrome_profile.sh**

```bash
#!/bin/bash
# Setup Chrome profile with manual logins

PROFILE_DIR="${CHROME_PROFILE:-$HOME/.config/agent-chrome-profile}"

echo "Setting up Chrome profile at: $PROFILE_DIR"
mkdir -p "$PROFILE_DIR"

echo ""
echo "Chrome will now open. Please:"
echo "1. Log into all sites you want the agent to access"
echo "2. Save passwords when prompted"
echo "3. Close Chrome when done"
echo ""
read -p "Press Enter to continue..."

# Launch Chrome
if [[ "$OSTYPE" == "darwin"* ]]; then
    "/Applications/Google Chrome.app/Contents/MacOS/Google Chrome" \
        --user-data-dir="$PROFILE_DIR" --no-first-run
else
    google-chrome --user-data-dir="$PROFILE_DIR" --no-first-run
fi

echo "Profile setup complete!"
```

**Deliverables**:
- [ ] Browser state in Redis
- [ ] Chrome profile setup script
- [ ] Logins persist across restarts

---

### Phase 7: Safety & Testing (Days 17-20)

**Goal**: Safety measures and end-to-end testing

#### 7.1 Safety Configuration

**config/safeguards.yaml**

```yaml
require_confirmation:
  patterns:
    - "checkout"
    - "purchase"
    - "buy"
    - "delete"
    - "send"
  timeout_minutes: 5

shell_blocklist:
  - "rm -rf /"
  - "rm -rf /*"
  - "dd if=/dev/"
  - "mkfs"
  - "> /dev/sd"

allowed_paths:
  - "/home"
  - "/tmp"
  - "~/Documents"
  - "~/Downloads"

rate_limits:
  requests_per_minute: 30
  browser_actions_per_minute: 60
```

#### 7.2 Test Scenarios

```
Test 1: Simple Navigation (Agent)
> "Go to google.com"
â†’ Router: AGENT (browser_agent)
â†’ Worker: aichat --agent browser_agent "go to google.com"

Test 2: Predefined Workflow (Macro)
> "Generate commit message"
â†’ Router: MACRO (generate-commit-message)
â†’ Worker: aichat --macro generate-commit-message

Test 3: Complex Task (Dynamic Plan)
> "Find 3BR houses in Richmond under $800/week and compare them"
â†’ Router: DYNAMIC_PLAN
â†’ Planner creates steps:
   1. browser_agent: Search realestate.com.au
   2. browser_agent: Extract listings
   3. research_agent: Compare and summarize
â†’ Steps execute sequentially

Test 4: Confirmation Flow
> "Buy milk from Woolworths"
â†’ Router: AGENT + requires_confirmation
â†’ User sees confirmation prompt
â†’ /confirm_abc123 â†’ Task executes
```

**Deliverables**:
- [ ] All test scenarios pass
- [ ] Safety blocklists enforced
- [ ] Confirmation flow works
- [ ] Error handling robust

---

## Final Project Structure

```
aichat-telegram-bot/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py
â”‚   â”œâ”€â”€ config.py
â”‚   â”‚
â”‚   â”œâ”€â”€ bot/
â”‚   â”‚   â”œâ”€â”€ poller.py
â”‚   â”‚   â””â”€â”€ handlers.py
â”‚   â”‚
â”‚   â”œâ”€â”€ gateway/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ router.py           # Classify â†’ macro/agent/dynamic
â”‚   â”‚   â”œâ”€â”€ planner.py          # Dynamic LLM-based planning
â”‚   â”‚   â”œâ”€â”€ executor.py         # Enqueue to RQ
â”‚   â”‚   â””â”€â”€ confirmation.py     # Redis-backed confirmations
â”‚   â”‚
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ telegram.py
â”‚   â”‚   â”œâ”€â”€ browser_state.py    # Redis browser state
â”‚   â”‚   â””â”€â”€ sessions.py
â”‚   â”‚
â”‚   â”œâ”€â”€ tasks/
â”‚   â”‚   â”œâ”€â”€ queues.py
â”‚   â”‚   â””â”€â”€ agent_tasks.py      # run_agent, run_macro, run_plan_step
â”‚   â”‚
â”‚   â””â”€â”€ db/
â”‚       â””â”€â”€ repository.py
â”‚
â”œâ”€â”€ functions/                   # llm-functions (git clone)
â”‚   â”œâ”€â”€ tools/
â”‚   â”‚   â”œâ”€â”€ browser_*.py        # Browser tools
â”‚   â”‚   â””â”€â”€ shell_*.sh          # System tools
â”‚   â”‚
â”‚   â”œâ”€â”€ agents/
â”‚   â”‚   â”œâ”€â”€ browser_agent/
â”‚   â”‚   â”œâ”€â”€ system_agent/
â”‚   â”‚   â””â”€â”€ research_agent/
â”‚   â”‚
â”‚   â””â”€â”€ tools.txt
â”‚
â”œâ”€â”€ config/
â”‚   â””â”€â”€ safeguards.yaml
â”‚
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ setup_chrome_profile.sh
â”‚
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ dev_plan_gateway.md
â”‚
â”œâ”€â”€ .env
â”œâ”€â”€ requirements.txt
â””â”€â”€ CLAUDE.md
```

---

## Timeline Summary

| Phase | Days | Focus |
|-------|------|-------|
| 0 | 1 | Prerequisites & llm-functions setup |
| 1 | 2-4 | Browser agent + Playwright tools |
| 2 | 5-6 | System agent + shell tools |
| 3 | 7-10 | Gateway (Router + Planner + Executor) |
| 4 | 11-12 | AIChat macros for common workflows |
| 5 | 13-14 | Research agent + multi-agent |
| 6 | 15-16 | Browser session management |
| 7 | 17-20 | Safety + testing + polish |

**Total: ~20 days**

---

## Key Decisions Summary

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Worker execution | Local `aichat` CLI | No HTTP API needed, AIChat handles agent loop |
| State storage | Redis | Survives restarts, shared across workers |
| Planning | Hybrid (Macros + Dynamic) | Macros for speed, Dynamic for flexibility |
| Confirmations | Redis-backed | Persists across bot restarts |
| Browser queue | Single worker | Playwright doesn't handle concurrency well |

---

## Next Steps

1. **Review this plan** - Any adjustments needed?
2. **Start Phase 0** - Clone llm-functions, verify setup
3. **Create first tool** - browser_navigate.py with Redis state
